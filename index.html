<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />

    <!-- SEO title & description -->
    <title>WebUSB STM32 Updater Tool | Silicon Witchery</title>
    <meta name="description" content="WebUSB based firmware upgrade tool for STM32 series devices.">
    <link rel="canonical" href="https://siliconwitchery.github.io/web-stm32-updater/" />

    <!-- Facebook & Twitter card meta -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@SiliconWitchery" />
    <meta property="og:title" content="WebUSB STM32 Updater Tool | Silicon Witchery" />
    <meta property="og:description" content="WebUSB based firmware upgrade tool for STM32 series devices." />
    <meta property="og:image" content="https://siliconwitchery.github.io/web-stm32-updater/images/share.jpg" />
    <meta property="og:url" content="https://siliconwitchery.github.io/web-stm32-updater/" />
    <meta property="og:type" content="website" />

    <!-- Script which contains the WebUSB API functions -->
    <script src="usb.js"></script>
</head>


<!-- Page HTML content -->

<body>
    <div class="app">

        <!-- Title -->
        <h1>WebUSB STM32 Updater Tool</h1>

        <!-- Buttons and progress bar -->
        <div class="buttons-and-bar">

            <!-- Connect/program button -->
            <button id="connectProgramButton">Connect</button>

            <!-- Progress bar -->
            <progress id="progressBar" value="0" max="100"></progress>

        </div>

        <!-- Footer -->
        <footer>

            <p>For help, bug reporting, and source code, visit the
                <a href="https://github.com/siliconwitchery/web-stm32-updater" target="_blank">repository</a>
            </p>

            <p>Copyright Â© 2022 <a href="https://www.siliconwitchery.com" target="_blank">Silicon Witchery</a></p>

        </footer>

    </div>

</body>


<!-- Javascript for interacting with the button and progress bar -->

<script>

    // Create a USB dfu object
    let dfu = new dfuDevice();

    // Reference to the buttons and progress bar
    const connectProgramButton = document.getElementById('connectProgramButton');
    const progressBar = document.getElementById('progressBar');

    // Logic for connecting when the button is pressed
    connectProgramButton.addEventListener('click', function () {

        // Run the update sequence
        runUpdateSequence();
    });

    // Executes the DFU sequence
    async function runUpdateSequence() {

        // Attempt the sequence
        try {

            // Update the button text and disable
            connectProgramButton.innerHTML = "Connecting";
            connectProgramButton.disabled = true;

            // Connect
            await dfu.connect();

            // Update the button text
            connectProgramButton.innerHTML = "Erasing";

            // Erase the chip
            await dfu.erase();

            // Update the button text
            connectProgramButton.innerHTML = "Programming";

            // Program the chip
            await dfu.program();

            // Update the button text
            connectProgramButton.innerHTML = "Booting";

            // Detach the device
            await dfu.detach();

            // Update the button text
            connectProgramButton.innerHTML = "Disconnecting";

            // Disconnect
            await dfu.disconnect();

            // Done
            alert("Update complete!");
        }

        // Catch errors
        catch (error) {

            // Always disconnect on error
            dfu.disconnect();

            // Print the error
            alert(error);
        }
    }

    // Updates the progress bar value
    function updateProgressBarHandler(value) {
        progressBar.value = value;
    }

    // Handles disconnect events
    function disconnectHandler() {

        // Reset the button back to 'connect'
        connectProgramButton.disabled = false;
        connectProgramButton.innerHTML = "Connect";

        // Reset the progress bar
        progressBar.value = 0;
    }

</script>

</html>