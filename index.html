<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />

    <!-- SEO title & description -->
    <title>WebUSB STM32 Updater Tool | Silicon Witchery</title>
    <meta name="description" content="WebUSB based firmware upgrade tool for STM32 series devices.">
    <link rel="canonical" href="https://siliconwitchery.github.io/web-stm32-updater/" />

    <!-- Facebook & Twitter card meta -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@SiliconWitchery" />
    <meta property="og:title" content="WebUSB STM32 Updater Tool | Silicon Witchery" />
    <meta property="og:description" content="WebUSB based firmware upgrade tool for STM32 series devices." />
    <meta property="og:image" content="https://siliconwitchery.github.io/web-stm32-updater/images/share.jpg" />
    <meta property="og:url" content="https://siliconwitchery.github.io/web-stm32-updater/" />
    <meta property="og:type" content="website" />

    <!-- Script which contains the WebUSB API functions -->
    <script src="usb.js"></script>
</head>


<!-- Page HTML content -->

<body>
    <div class="app">

        <!-- Title -->
        <h1>WebUSB STM32 Updater Tool</h1>
        <p>This tool uses the WebUSB API to perform device firmware upgrade (DFU) on STM32 devices. Paste the link to
            your file below and click connect to start the process. Visit our repository below to learn how this tool
            works, and fork your own version with whatever customizations you need. Make sure you're using Chromium or
            the latest <a href="https://www.google.com/chrome/" target="_blank">Chrome Desktop</a>.
        </p>

        <!-- Update file entry box -->
        <input id="fileLocation" type="url" placeholder="https://server/yourFile.bin">

        <!-- Buttons and progress bar -->
        <div class="buttons-and-bar">

            <!-- Connect/program button -->
            <button id="connectProgramButton">Connect</button>

            <!-- Progress bar -->
            <progress id="progressBar" value="0" max="100"></progress>

        </div>

        <!-- Footer -->
        <footer>

            <p>For help, bug reporting, and source code, visit the
                <a href="https://github.com/siliconwitchery/web-stm32-updater" target="_blank">repository</a>
            </p>

            <p>Copyright Â© 2022 <a href="https://www.siliconwitchery.com" target="_blank">Silicon Witchery</a></p>

        </footer>

    </div>

</body>


<!-- Javascript for interacting with the button and progress bar -->

<script>

    // Create a USB dfu device object
    let dfu = new usbDfuDevice();

    // Reference to the file location box, button and progress bar
    const fileLocation = document.getElementById('fileLocation');
    const connectProgramButton = document.getElementById('connectProgramButton');
    const progressBar = document.getElementById('progressBar');

    // When the button is clicked
    connectProgramButton.addEventListener('click', function () {

        // Start the update function (This is an async process)
        startUpdate();
    });

    async function startUpdate() {

        // Disable the button
        connectProgramButton.disabled = true;

        try {
            // Disallow empty URLs
            if (fileLocation.value == "") {
                throw ("No URL provided");
            }

            let response = await fetch(fileLocation.value).catch(function (error) {
                throw (error);
            })

            // Create byte array from the response
            // let binaryData = new Uint8Array(response);

            // Run the update sequence
            // runUpdateSequence(binaryData)

        }

        catch (error) {
            // Reset the button and progress bar
            dfuDisconnectHandler();

            // Show the error as alert
            alert(error);
        }
    }

    // Updates the button text
    function dfuStatusHandler(status) {
        connectProgramButton.innerHTML = status;
    }

    // Updates the progress bar value
    function dfuProgressHandler(value) {
        progressBar.value = value;
    }

    // Handles disconnect events
    function dfuDisconnectHandler() {

        // Reset the button back to 'connect'
        connectProgramButton.disabled = false;
        connectProgramButton.innerHTML = "Connect";

        // Reset the progress bar
        progressBar.value = 0;
    }

</script>

</html>